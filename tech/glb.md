# 异地多活

- 异地：地理位置不同
- 多活：不同地理位置上的系统，都能提供业务服务
   - 无论访问哪个地区的服务，都能得到正确的业务服务
   - 某地区服务异常，用户可以访问其他地区服务得到正确的业务服务

## Overview

2018年9月份云栖大会上蚂蚁金服当场把杭州的2个IDC的网线剪短...

### Buzz Words

- 单元化 Set
   - 一个单元可以包含多个IDC，但通常对应一个IDC
   - 纯粹的单元化解决的是：就近访问的问题
   - 相关技术：流量调度
   - 加上数据同步技术，就形成了异地多活
- 异地多活
   - 数据同步是异地多活的基础
   - DB/Cache/MQ

### 容灾级别

- 单节点容灾
   - app/db/cache/mq broker
- rack容灾
   - 故障类型：交换机故障/电源
   - 交换机容错、电源容错可以解决
- 机房容灾
   - 故障类型：机房火灾/水灾/停电/空调故障/光缆切断
   - 光缆切断，可以通过额外增加线路解决
   - 2个IDC并不具备机房容灾能力，至少需要3个IDC，因为zk/redis/etcd/consul等需要quorum
   - 部署3个节点，但只有2个IDC，那么节点分布必然(2, 1)，当2的IDC挂了，则剩下的节点/IDC无法形成quorum，无法正常工作
   - 3个IDC，每个IDC部署一个节点，那么一个IDC挂了还剩2节点，这就是“2地3中心”
- 城市容灾
   - 故障类型：地震/水灾/城市大停电/战争/政治隔离(新疆)
   - 3地5中心(OceanBase)
      - 3个城市拥有IDC(2, 2, 1)
      - 1个城市发生灾难，其他2个城市至少保证3个IDC存活，可以形成quorum
- 国家故障
   - Spanner

### 部署结构

- 同城异区(N AZ within a Region)
   - 异区IDC之间通过专线连接，距离100KM-
   - RTT可以几乎与同一个机房相同
      - 降低系统复杂度
   - nasdaq的方案
   - 无法解决极端的城市容灾问题
- 跨城异地
   - 城市间距离要足够长(例如：北京/广州)
      - 否则解决不了地震问题
   - 无法解决强一致性要求数据的场景(存款余额)
      - 用户登录(不一致，那就重新登录)
      - content based site
      - twitter(即使丢失twitter/comments影响也不大，用户可能觉察不出来)
- 跨国异地
   - aws
      - 亚洲账户是无法登录美国的
   - google
      - readonly scenario
      - 无论在哪个国家搜索，结果基本相同

### Hard to solve problems

- 强一致要求的数据
   - 存款余额(无法异地多活)
   - bj(A)转账给hz(B) $100

## TODO

- how aws solve HA accross regions


### 成本

- 系统复杂度
- 部署成本
- 数据复制成本
- 运维成本
